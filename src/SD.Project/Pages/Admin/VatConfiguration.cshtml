@page
@model SD.Project.Pages.Admin.VatConfigurationModel
@{
    ViewData["Title"] = "VAT Configuration";
}

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>VAT Configuration</h1>
            <p class="text-muted mb-0">Manage VAT and tax rates per country and category for compliant calculations and invoices.</p>
        </div>
        <div>
            <a asp-page="/Admin/VatHistory" class="btn btn-outline-secondary me-2">
                <i class="bi bi-clock-history me-1"></i> View History
            </a>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createRuleModal">
                <i class="bi bi-plus-lg me-1"></i> Add VAT Rule
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @Model.SuccessMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="card-title mb-0">@Model.Rules.Count</h3>
                    <p class="card-text text-muted mb-0">Total Rules</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="card-title mb-0 text-success">@Model.Rules.Count(r => r.IsCurrentlyEffective)</h3>
                    <p class="card-text text-muted mb-0">Currently Effective</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="card-title mb-0 text-info">@Model.Rules.Count(r => r.IsFutureDated)</h3>
                    <p class="card-text text-muted mb-0">Scheduled</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="card-title mb-0 text-primary">@Model.Rules.Select(r => r.CountryCode).Distinct().Count()</h3>
                    <p class="card-text text-muted mb-0">Countries</p>
                </div>
            </div>
        </div>
    </div>

    @if (Model.Rules.Count == 0)
    {
        <div class="card">
            <div class="card-body text-center py-5">
                <h4 class="text-muted">No VAT rules configured</h4>
                <p class="text-muted">Set up VAT rules to define tax rates for different countries and categories.</p>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createRuleModal">
                    Add Your First VAT Rule
                </button>
            </div>
        </div>
    }
    else
    {
        // Group rules by country
        var rulesByCountry = Model.Rules.GroupBy(r => new { r.CountryCode, r.CountryName })
            .OrderBy(g => g.Key.CountryName)
            .ToList();

        foreach (var countryGroup in rulesByCountry)
        {
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-flag me-2"></i>@countryGroup.Key.CountryName
                        <span class="badge bg-secondary ms-2">@countryGroup.Count() rule(s)</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Rate</th>
                                    <th>Scope</th>
                                    <th>Effective Period</th>
                                    <th>Status</th>
                                    <th>Last Modified</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var rule in countryGroup.OrderBy(r => r.CategoryId.HasValue ? 1 : 0).ThenBy(r => r.Name))
                                {
                                    <tr>
                                        <td>
                                            <strong>@rule.Name</strong>
                                            @if (!string.IsNullOrEmpty(rule.Description))
                                            {
                                                <br />
                                                <small class="text-muted">@rule.Description</small>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge bg-primary fs-6">@rule.FormattedRate</span>
                                        </td>
                                        <td>
                                            @if (rule.CategoryId.HasValue)
                                            {
                                                <span class="badge bg-info">@rule.CategoryName</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">All categories</span>
                                            }
                                        </td>
                                        <td>@rule.EffectiveDateRangeDisplay</td>
                                        <td>
                                            <span class="badge @rule.StatusBadgeClass">@rule.StatusDisplay</span>
                                        </td>
                                        <td>
                                            <small>@rule.LastModifiedDisplay</small>
                                        </td>
                                        <td class="text-end">
                                            <div class="btn-group btn-group-sm">
                                                <button type="button"
                                                        class="btn btn-outline-secondary"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#editRuleModal"
                                                        data-rule-id="@rule.Id"
                                                        data-rule-name="@rule.Name"
                                                        data-rule-rate="@rule.TaxRate"
                                                        data-rule-country="@rule.CountryCode"
                                                        data-rule-country-name="@rule.CountryName"
                                                        data-rule-category="@rule.CategoryId"
                                                        data-rule-category-name="@rule.CategoryName"
                                                        data-rule-from="@rule.EffectiveFrom?.ToString("yyyy-MM-dd")"
                                                        data-rule-to="@rule.EffectiveTo?.ToString("yyyy-MM-dd")"
                                                        data-rule-description="@rule.Description">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <form method="post" asp-page-handler="ToggleStatus" class="d-inline">
                                                    <input type="hidden" name="ruleId" value="@rule.Id" />
                                                    <button type="submit" class="btn btn-outline-secondary" title="@(rule.IsActive ? "Deactivate" : "Activate")">
                                                        @if (rule.IsActive)
                                                        {
                                                            <i class="bi bi-pause-fill"></i>
                                                        }
                                                        else
                                                        {
                                                            <i class="bi bi-play-fill"></i>
                                                        }
                                                    </button>
                                                </form>
                                                <a asp-page="/Admin/VatHistory" asp-route-ruleId="@rule.Id" class="btn btn-outline-secondary" title="View History">
                                                    <i class="bi bi-clock-history"></i>
                                                </a>
                                                <form method="post" asp-page-handler="Delete" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this VAT rule?');">
                                                    <input type="hidden" name="ruleId" value="@rule.Id" />
                                                    <button type="submit" class="btn btn-outline-danger">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    }

    <div class="mt-4">
        <a asp-page="/Admin/Dashboard" class="btn btn-outline-secondary">Back to Dashboard</a>
    </div>
</div>

<!-- Create Rule Modal -->
<div class="modal fade" id="createRuleModal" tabindex="-1" aria-labelledby="createRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-page-handler="Create">
                <div class="modal-header">
                    <h5 class="modal-title" id="createRuleModalLabel">Create VAT Rule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="NewRule.CountryCode" class="form-label">Country <span class="text-danger">*</span></label>
                            <select asp-for="NewRule.CountryCode" asp-items="Model.CountryOptions" class="form-select">
                            </select>
                            <span asp-validation-for="NewRule.CountryCode" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="NewRule.CategoryId" class="form-label">Category</label>
                            <select asp-for="NewRule.CategoryId" asp-items="Model.CategoryOptions" class="form-select">
                            </select>
                            <div class="form-text">Leave as "All categories" for country-wide rules.</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="NewRule.Name" class="form-label">Rate Name <span class="text-danger">*</span></label>
                            <input asp-for="NewRule.Name" class="form-control" placeholder="e.g., Standard Rate, Reduced Rate" />
                            <span asp-validation-for="NewRule.Name" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="NewRule.TaxRate" class="form-label">Tax Rate (%) <span class="text-danger">*</span></label>
                            <input asp-for="NewRule.TaxRate" class="form-control" type="number" step="0.01" min="0" max="100" placeholder="e.g., 23.00" />
                            <span asp-validation-for="NewRule.TaxRate" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="NewRule.EffectiveFrom" class="form-label">Effective From</label>
                            <input asp-for="NewRule.EffectiveFrom" class="form-control" type="date" />
                            <div class="form-text">Leave empty for immediate effect.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="NewRule.EffectiveTo" class="form-label">Effective To</label>
                            <input asp-for="NewRule.EffectiveTo" class="form-control" type="date" />
                            <div class="form-text">Leave empty for no end date.</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label asp-for="NewRule.Description" class="form-label">Description</label>
                        <textarea asp-for="NewRule.Description" class="form-control" rows="2" placeholder="Optional description or legal reference"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Rule</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Rule Modal -->
<div class="modal fade" id="editRuleModal" tabindex="-1" aria-labelledby="editRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-page-handler="Edit">
                <div class="modal-header">
                    <h5 class="modal-title" id="editRuleModalLabel">Edit VAT Rule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" asp-for="EditRule.RuleId" id="editRuleId" />
                    <div class="mb-3">
                        <label class="form-label">Country</label>
                        <input type="text" class="form-control" id="editCountryDisplay" readonly />
                        <div class="form-text">Country cannot be changed after creation. Create a new rule for a different country.</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="EditRule.Name" class="form-label">Rate Name <span class="text-danger">*</span></label>
                            <input asp-for="EditRule.Name" class="form-control" id="editName" />
                            <span asp-validation-for="EditRule.Name" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="EditRule.TaxRate" class="form-label">Tax Rate (%) <span class="text-danger">*</span></label>
                            <input asp-for="EditRule.TaxRate" class="form-control" id="editTaxRate" type="number" step="0.01" min="0" max="100" />
                            <span asp-validation-for="EditRule.TaxRate" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label asp-for="EditRule.CategoryId" class="form-label">Category</label>
                        <select asp-for="EditRule.CategoryId" asp-items="Model.CategoryOptions" class="form-select" id="editCategoryId">
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="EditRule.EffectiveFrom" class="form-label">Effective From</label>
                            <input asp-for="EditRule.EffectiveFrom" class="form-control" id="editEffectiveFrom" type="date" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="EditRule.EffectiveTo" class="form-label">Effective To</label>
                            <input asp-for="EditRule.EffectiveTo" class="form-control" id="editEffectiveTo" type="date" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label asp-for="EditRule.Description" class="form-label">Description</label>
                        <textarea asp-for="EditRule.Description" class="form-control" id="editDescription" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label asp-for="EditRule.ChangeReason" class="form-label">Change Reason</label>
                        <textarea asp-for="EditRule.ChangeReason" class="form-control" rows="2" placeholder="Optional reason for this change (recorded in audit history)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('editRuleModal').addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            document.getElementById('editRuleId').value = button.getAttribute('data-rule-id');
            document.getElementById('editCountryDisplay').value = button.getAttribute('data-rule-country-name');
            document.getElementById('editName').value = button.getAttribute('data-rule-name');
            document.getElementById('editTaxRate').value = button.getAttribute('data-rule-rate');
            document.getElementById('editCategoryId').value = button.getAttribute('data-rule-category') || '';
            document.getElementById('editEffectiveFrom').value = button.getAttribute('data-rule-from') || '';
            document.getElementById('editEffectiveTo').value = button.getAttribute('data-rule-to') || '';
            document.getElementById('editDescription').value = button.getAttribute('data-rule-description') || '';
        });
    </script>
}
