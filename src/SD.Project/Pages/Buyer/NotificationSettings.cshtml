@page
@model SD.Project.Pages.Buyer.NotificationSettingsModel
@{
    ViewData["Title"] = "Notification Settings";
}

<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-page="/Buyer/Dashboard">Dashboard</a></li>
            <li class="breadcrumb-item"><a asp-page="/Buyer/Notifications">Notifications</a></li>
            <li class="breadcrumb-item active" aria-current="page">Settings</li>
        </ol>
    </nav>

    <h1 class="mb-4">Notification Settings</h1>

    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @Model.SuccessMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row">
        <div class="col-md-8">
            <!-- Push Notifications Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-bell me-2"></i>Push Notifications
                    </h5>
                </div>
                <div class="card-body">
                    <div id="push-not-supported" class="alert alert-warning" style="display: none;">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Push notifications are not supported in your browser.
                    </div>

                    <div id="push-permission-denied" class="alert alert-warning" style="display: none;">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Push notification permission was denied. Please enable notifications in your browser settings.
                    </div>

                    <div id="push-controls">
                        <p class="text-muted mb-3">
                            Receive important notifications even when you're not on the Mercato website.
                            Push notifications keep you informed about orders, messages, and other important updates.
                        </p>

                        <div class="d-flex align-items-center justify-content-between mb-4 p-3 bg-light rounded">
                            <div>
                                <strong>Enable Push Notifications</strong>
                                <p class="text-muted mb-0 small">
                                    Get instant notifications on this device
                                </p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input form-switch-lg" type="checkbox" role="switch" 
                                       id="push-toggle">
                            </div>
                        </div>

                        <div id="push-status" class="mb-3">
                            <span class="badge bg-secondary" id="push-status-badge">Checking...</span>
                        </div>
                    </div>

                    <!-- Device List -->
                    <div id="device-list-section" style="display: none;">
                        <hr class="my-4">
                        <h6 class="mb-3">Registered Devices</h6>
                        <div id="device-list">
                            <div class="text-muted">Loading devices...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notification Types Section (future enhancement) -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-sliders me-2"></i>Notification Preferences
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Choose which types of notifications you want to receive.
                    </p>
                    
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div>
                                <strong>Order Updates</strong>
                                <p class="text-muted mb-0 small">Shipping updates, delivery confirmations</p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" checked disabled 
                                       title="This notification type is always enabled">
                            </div>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div>
                                <strong>Messages</strong>
                                <p class="text-muted mb-0 small">New messages from sellers</p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" checked disabled 
                                       title="This notification type is always enabled">
                            </div>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div>
                                <strong>Returns & Refunds</strong>
                                <p class="text-muted mb-0 small">Updates on your return requests</p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" checked disabled 
                                       title="This notification type is always enabled">
                            </div>
                        </div>
                    </div>
                    
                    <p class="text-muted small mt-3">
                        <i class="bi bi-info-circle me-1"></i>
                        More granular notification preferences coming soon.
                    </p>
                </div>
            </div>
        </div>

        <!-- Help Section -->
        <div class="col-md-4">
            <div class="card bg-light">
                <div class="card-body">
                    <h6><i class="bi bi-question-circle me-2"></i>About Push Notifications</h6>
                    <p class="small text-muted">
                        Push notifications are delivered directly to your device, even when you're not 
                        browsing Mercato. They help you stay updated on:
                    </p>
                    <ul class="small text-muted">
                        <li>Order status changes</li>
                        <li>New messages from sellers</li>
                        <li>Return request updates</li>
                        <li>Payment confirmations</li>
                    </ul>
                    <p class="small text-muted mb-0">
                        You can disable push notifications at any time using the toggle above or 
                        through your browser settings.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
(function() {
    'use strict';

    var pushToggle = document.getElementById('push-toggle');
    var pushStatusBadge = document.getElementById('push-status-badge');
    var pushNotSupported = document.getElementById('push-not-supported');
    var pushPermissionDenied = document.getElementById('push-permission-denied');
    var pushControls = document.getElementById('push-controls');
    var deviceListSection = document.getElementById('device-list-section');
    var deviceList = document.getElementById('device-list');

    // Initialize
    async function init() {
        if (!window.MercatoPush || !window.MercatoPush.isSupported()) {
            showNotSupported();
            return;
        }

        var permission = window.MercatoPush.getPermission();
        if (permission === 'denied') {
            showPermissionDenied();
        }

        await updatePushStatus();
        await loadDevices();

        // Set up toggle handler
        pushToggle.addEventListener('change', handleToggle);
    }

    function showNotSupported() {
        pushNotSupported.style.display = 'block';
        pushControls.style.display = 'none';
    }

    function showPermissionDenied() {
        pushPermissionDenied.style.display = 'block';
    }

    async function updatePushStatus() {
        var isEnabled = await window.MercatoPush.isEnabled();
        pushToggle.checked = isEnabled;
        
        if (isEnabled) {
            pushStatusBadge.textContent = 'Enabled';
            pushStatusBadge.className = 'badge bg-success';
            deviceListSection.style.display = 'block';
        } else {
            pushStatusBadge.textContent = 'Disabled';
            pushStatusBadge.className = 'badge bg-secondary';
        }
    }

    async function handleToggle() {
        pushToggle.disabled = true;
        pushStatusBadge.textContent = 'Processing...';
        pushStatusBadge.className = 'badge bg-warning';

        try {
            if (pushToggle.checked) {
                var result = await window.MercatoPush.subscribe();
                if (!result.success) {
                    pushToggle.checked = false;
                    if (result.error === 'Permission denied') {
                        showPermissionDenied();
                    } else {
                        alert('Failed to enable push notifications: ' + result.error);
                    }
                }
            } else {
                await window.MercatoPush.unsubscribe();
            }
        } catch (error) {
            console.error('Toggle error:', error);
            pushToggle.checked = !pushToggle.checked;
        }

        pushToggle.disabled = false;
        await updatePushStatus();
        await loadDevices();
    }

    async function loadDevices() {
        try {
            var response = await fetch('/Api/PushSubscription?handler=Subscriptions');
            var data = await response.json();
            
            if (data.subscriptions && data.subscriptions.length > 0) {
                deviceListSection.style.display = 'block';
                renderDevices(data.subscriptions);
            } else {
                deviceListSection.style.display = 'none';
            }
        } catch (error) {
            console.error('Failed to load devices:', error);
            deviceList.innerHTML = '<div class="text-danger small">Failed to load devices</div>';
        }
    }

    function renderDevices(devices) {
        var html = '<div class="list-group list-group-flush">';
        
        devices.forEach(function(device) {
            var statusClass = device.isEnabled ? 'text-success' : 'text-muted';
            var statusIcon = device.isEnabled ? 'bi-check-circle-fill' : 'bi-circle';
            var lastUsed = device.lastUsedAt 
                ? 'Last active: ' + new Date(device.lastUsedAt).toLocaleDateString() 
                : 'Never used';
            
            html += '<div class="list-group-item d-flex justify-content-between align-items-center px-0">' +
                '<div>' +
                    '<i class="bi bi-phone me-2"></i>' +
                    '<span>' + (device.deviceName || 'Unknown Device') + '</span>' +
                    '<br><small class="text-muted">' + lastUsed + '</small>' +
                '</div>' +
                '<span class="' + statusClass + '"><i class="bi ' + statusIcon + '"></i></span>' +
            '</div>';
        });
        
        html += '</div>';
        deviceList.innerHTML = html;
    }

    // Wait for MercatoPush to be available
    if (window.MercatoPush) {
        init();
    } else {
        window.addEventListener('load', function() {
            setTimeout(init, 500);
        });
    }
})();
</script>
}
