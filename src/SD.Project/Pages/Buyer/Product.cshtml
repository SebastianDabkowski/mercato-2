@page
@model SD.Project.Pages.Buyer.ProductModel
@using SD.Project.Domain.Repositories
@{
    ViewData["Title"] = Model.Product?.Name ?? "Product Not Found";
}

@if (Model.Product is null)
{
    <div class="alert alert-warning" role="alert">
        <h4 class="alert-heading">Product Not Found</h4>
        <p>The product you're looking for doesn't exist or is no longer available.</p>
        <hr>
        <p class="mb-0">
            <a asp-page="/Buyer/Search" class="alert-link">Search for products</a> or
            <a asp-page="/Buyer/Category" asp-route-id="" class="alert-link">browse categories</a>.
        </p>
    </div>
}
else
{
    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert @(Model.IsSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
            @Model.Message
            @if (Model.IsSuccess)
            {
                <a asp-page="/Buyer/Cart" class="alert-link ms-2">View Cart</a>
            }
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    
    <div data-product-id="@Model.Product.Id" data-max-recent-items="10">
        <!-- Back to Results Button -->
        <div class="mb-3">
            <a href="javascript:history.back()" class="btn btn-outline-secondary btn-sm" id="back-to-results-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left me-1" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Back to results
            </a>
        </div>

        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-page="/Index">Home</a></li>
                <li class="breadcrumb-item"><a asp-page="/Buyer/Category" asp-route-id="">Categories</a></li>
                @if (!string.IsNullOrEmpty(Model.Product.Category))
                {
                    @if (Model.CategoryId.HasValue)
                    {
                        <li class="breadcrumb-item"><a asp-page="/Buyer/Category" asp-route-id="@Model.CategoryId">@Model.Product.Category</a></li>
                    }
                    else
                    {
                        <li class="breadcrumb-item"><a asp-page="/Buyer/Search" asp-route-q="" asp-route-CategoryFilter="@Model.Product.Category">@Model.Product.Category</a></li>
                    }
                }
                <li class="breadcrumb-item active" aria-current="page">@Model.Product.Name</li>
            </ol>
        </nav>

        <div class="row">
            <!-- Product Image -->
            <div class="col-md-6 mb-4">
                @if (!string.IsNullOrEmpty(Model.Product.MainImageUrl))
                {
                    <img src="@Model.Product.MainImageUrl" class="img-fluid rounded" alt="@Model.Product.Name">
                }
                else
                {
                    <div class="bg-light d-flex align-items-center justify-content-center rounded" style="height: 400px;">
                        <span class="text-muted">No Image Available</span>
                    </div>
                }
            </div>

            <!-- Product Details -->
            <div class="col-md-6">
                <h1 class="mb-3">@Model.Product.Name</h1>

                <p class="lead mb-3">
                    <strong class="text-primary">@Model.Product.Currency @Model.Product.Amount.ToString("N2")</strong>
                </p>

                <div class="mb-3">
                    @if (Model.Product.Stock > 0)
                    {
                        <span class="badge bg-success fs-6">In Stock</span>
                        <span class="text-muted ms-2">(@Model.Product.Stock available)</span>
                    }
                    else
                    {
                        <span class="badge bg-danger fs-6">Out of Stock</span>
                    }
                </div>

                @if (!string.IsNullOrEmpty(Model.Product.Category))
                {
                    <p class="mb-2">
                        <strong>Category:</strong>
                        @if (Model.CategoryId.HasValue)
                        {
                            <a asp-page="/Buyer/Category" asp-route-id="@Model.CategoryId">@Model.Product.Category</a>
                        }
                        else
                        {
                            <a asp-page="/Buyer/Search" asp-route-q="" asp-route-CategoryFilter="@Model.Product.Category">@Model.Product.Category</a>
                        }
                    </p>
                }

                @if (Model.Store is not null)
                {
                    <p class="mb-2">
                        <strong>Seller:</strong>
                        <a asp-page="/Store" asp-route-slug="@Model.Store.Slug">@Model.Store.Name</a>
                    </p>
                }

                @if (!string.IsNullOrEmpty(Model.Product.Description))
                {
                    <div class="mb-4">
                        <h5>Description</h5>
                        <p>@Model.Product.Description</p>
                    </div>
                }

                <!-- Shipping Information -->
                @if (Model.Product.WeightKg.HasValue || Model.Product.LengthCm.HasValue || Model.Product.WidthCm.HasValue || Model.Product.HeightCm.HasValue)
                {
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Shipping Information</h6>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                @if (Model.Product.WeightKg.HasValue)
                                {
                                    <dt class="col-sm-4">Weight</dt>
                                    <dd class="col-sm-8">@Model.Product.WeightKg.Value.ToString("N2") kg</dd>
                                }
                                @if (Model.Product.LengthCm.HasValue && Model.Product.WidthCm.HasValue && Model.Product.HeightCm.HasValue)
                                {
                                    <dt class="col-sm-4">Dimensions</dt>
                                    <dd class="col-sm-8">@Model.Product.LengthCm.Value.ToString("N1") × @Model.Product.WidthCm.Value.ToString("N1") × @Model.Product.HeightCm.Value.ToString("N1") cm</dd>
                                }
                            </dl>
                        </div>
                    </div>
                }

                <div class="d-grid gap-2">
                    @if (Model.Product.Stock > 0)
                    {
                        <form method="post" asp-page-handler="AddToCart">
                            <input type="hidden" name="productId" value="@Model.Product.Id" />
                            <input type="hidden" name="quantity" value="1" />
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-cart-plus me-2" viewBox="0 0 16 16">
                                    <path d="M9 5.5a.5.5 0 0 0-1 0V7H6.5a.5.5 0 0 0 0 1H8v1.5a.5.5 0 0 0 1 0V8h1.5a.5.5 0 0 0 0-1H9z" />
                                    <path d="M.5 1a.5.5 0 0 0 0 1h1.11l.401 1.607 1.498 7.985A.5.5 0 0 0 4 12h1a2 2 0 1 0 0 4 2 2 0 0 0 0-4h7a2 2 0 1 0 0 4 2 2 0 0 0 0-4h1a.5.5 0 0 0 .491-.408l1.5-8A.5.5 0 0 0 14.5 3H2.89l-.405-1.621A.5.5 0 0 0 2 1zm3.915 10L3.102 4h10.796l-1.313 7zM6 14a1 1 0 1 1-2 0 1 1 0 0 1 2 0m7 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0" />
                                </svg>
                                Add to Cart
                            </button>
                        </form>
                    }
                    else
                    {
                        <button type="button" class="btn btn-secondary btn-lg" disabled>
                            Out of Stock
                        </button>
                    }
                </div>
            </div>
        </div>

        <!-- Customer Reviews Section -->
        <section class="mt-5" id="reviews">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="mb-0">Customer Reviews</h4>
                    @if (Model.Rating is not null && Model.Rating.ReviewCount > 0)
                    {
                        <div class="d-flex align-items-center mt-2">
                            <div class="text-warning me-2">
                                @{
                                    var fullStars = (int)Math.Floor(Model.Rating.AverageRating);
                                    var hasHalfStar = Model.Rating.AverageRating - fullStars >= 0.5;
                                }
                                @for (int i = 1; i <= 5; i++)
                                {
                                    if (i <= fullStars)
                                    {
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-star-fill" viewBox="0 0 16 16">
                                            <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                                        </svg>
                                    }
                                    else if (i == fullStars + 1 && hasHalfStar)
                                    {
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-star-half" viewBox="0 0 16 16">
                                            <path d="M5.354 5.119 7.538.792A.52.52 0 0 1 8 .5c.183 0 .366.097.465.292l2.184 4.327 4.898.696A.54.54 0 0 1 16 6.32a.55.55 0 0 1-.17.445l-3.523 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256a.5.5 0 0 1-.146.05c-.342.06-.668-.254-.6-.642l.83-4.73L.173 6.765a.55.55 0 0 1-.172-.403.6.6 0 0 1 .085-.302.51.51 0 0 1 .37-.245zM8 12.027a.5.5 0 0 1 .232.056l3.686 1.894-.694-3.957a.56.56 0 0 1 .162-.505l2.907-2.77-4.052-.576a.53.53 0 0 1-.393-.288L8.001 2.223 8 2.226z"/>
                                        </svg>
                                    }
                                    else
                                    {
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16">
                                            <path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.441.062-.612.636-.283.95l3.523 3.356-.83 4.73zm4.905-2.767-3.686 1.894.694-3.957a.56.56 0 0 0-.163-.505L1.71 6.745l4.052-.576a.53.53 0 0 0 .393-.288L8 2.223l1.847 3.658a.53.53 0 0 0 .393.288l4.052.575-2.906 2.77a.56.56 0 0 0-.163.506l.694 3.957-3.686-1.894a.5.5 0 0 0-.461 0z"/>
                                        </svg>
                                    }
                                }
                            </div>
                            <span class="fw-bold me-2">@Model.Rating.RatingDisplay</span>
                            <span class="text-muted">(@Model.Rating.ReviewCount @(Model.Rating.ReviewCount == 1 ? "review" : "reviews"))</span>
                        </div>
                    }
                </div>
                @if (Model.TotalReviewCount > 0)
                {
                    <div>
                        <label class="me-2" for="reviewSortSelect">Sort by:</label>
                        <select id="reviewSortSelect" class="form-select form-select-sm d-inline-block w-auto" onchange="updateReviewSort(this.value)">
                            @if (Model.ReviewSort == ReviewSortOrder.Newest)
                            {
                                <option value="@ReviewSortOrder.Newest" selected>Newest</option>
                            }
                            else
                            {
                                <option value="@ReviewSortOrder.Newest">Newest</option>
                            }
                            @if (Model.ReviewSort == ReviewSortOrder.HighestRating)
                            {
                                <option value="@ReviewSortOrder.HighestRating" selected>Highest Rating</option>
                            }
                            else
                            {
                                <option value="@ReviewSortOrder.HighestRating">Highest Rating</option>
                            }
                            @if (Model.ReviewSort == ReviewSortOrder.LowestRating)
                            {
                                <option value="@ReviewSortOrder.LowestRating" selected>Lowest Rating</option>
                            }
                            else
                            {
                                <option value="@ReviewSortOrder.LowestRating">Lowest Rating</option>
                            }
                        </select>
                    </div>
                }
            </div>

            @if (Model.TotalReviewCount == 0)
            {
                <div class="alert alert-light border text-center py-5" role="alert">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-chat-left-text text-muted mb-3" viewBox="0 0 16 16">
                        <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                        <path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5M3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6m0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5"/>
                    </svg>
                    <h5 class="text-muted mb-2">No Reviews Yet</h5>
                    <p class="text-muted mb-0">Be the first to review this product after making a purchase.</p>
                </div>
            }
            else
            {
                <div class="list-group mb-4">
                    @foreach (var review in Model.Reviews)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <div class="text-warning mb-1">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            if (i <= review.Rating)
                                            {
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star-fill" viewBox="0 0 16 16">
                                                    <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                                                </svg>
                                            }
                                            else
                                            {
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16">
                                                    <path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.441.062-.612.636-.283.95l3.523 3.356-.83 4.73zm4.905-2.767-3.686 1.894.694-3.957a.56.56 0 0 0-.163-.505L1.71 6.745l4.052-.576a.53.53 0 0 0 .393-.288L8 2.223l1.847 3.658a.53.53 0 0 0 .393.288l4.052.575-2.906 2.77a.56.56 0 0 0-.163.506l.694 3.957-3.686-1.894a.5.5 0 0 0-.461 0z"/>
                                                </svg>
                                            }
                                        }
                                    </div>
                                    <strong>@(review.BuyerName ?? "Anonymous")</strong>
                                </div>
                                <small class="text-muted">@review.CreatedAt.ToString("MMM d, yyyy")</small>
                            </div>
                            @if (!string.IsNullOrEmpty(review.Comment))
                            {
                                <p class="mb-0">@review.Comment</p>
                            }
                        </div>
                    }
                </div>

                <!-- Pagination -->
                @if (Model.TotalReviewPages > 1)
                {
                    <nav aria-label="Review pages">
                        <ul class="pagination justify-content-center">
                            <li class="page-item @(Model.ReviewPage <= 1 ? "disabled" : "")">
                                <a class="page-link" asp-page="/Buyer/Product" asp-route-id="@Model.Product.Id" asp-route-ReviewPage="@(Model.ReviewPage - 1)" asp-route-ReviewSort="@Model.ReviewSort" asp-fragment="reviews">Previous</a>
                            </li>
                            @for (int i = 1; i <= Model.TotalReviewPages; i++)
                            {
                                <li class="page-item @(i == Model.ReviewPage ? "active" : "")">
                                    <a class="page-link" asp-page="/Buyer/Product" asp-route-id="@Model.Product.Id" asp-route-ReviewPage="@i" asp-route-ReviewSort="@Model.ReviewSort" asp-fragment="reviews">@i</a>
                                </li>
                            }
                            <li class="page-item @(Model.ReviewPage >= Model.TotalReviewPages ? "disabled" : "")">
                                <a class="page-link" asp-page="/Buyer/Product" asp-route-id="@Model.Product.Id" asp-route-ReviewPage="@(Model.ReviewPage + 1)" asp-route-ReviewSort="@Model.ReviewSort" asp-fragment="reviews">Next</a>
                            </li>
                        </ul>
                    </nav>
                }
            }
        </section>

        <!-- Product Q&A Section -->
        <section class="mt-5" id="questions">
            <h4 class="mb-4">Questions & Answers</h4>

            <!-- Ask a Question Form -->
            @if (User.Identity?.IsAuthenticated == true)
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">Have a question about this product?</h6>
                    </div>
                    <div class="card-body">
                        <form method="post" asp-page-handler="AskQuestion" asp-route-productId="@Model.Product.Id">
                            <div class="mb-3">
                                <textarea class="form-control" asp-for="QuestionInput.Question" rows="3" 
                                          placeholder="Ask the seller a question about this product..." 
                                          maxlength="2000" required></textarea>
                                <div class="form-text">Maximum 2000 characters</div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-question-circle me-1" viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                    <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                                </svg>
                                Submit Question
                            </button>
                        </form>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-info mb-4">
                    <a asp-page="/Login" asp-route-returnUrl="@($"/Buyer/Product?id={Model.Product.Id}#questions")">Log in</a> to ask a question about this product.
                </div>
            }

            <!-- Q&A List -->
            @if (Model.Questions.Count == 0)
            {
                <div class="alert alert-light border text-center py-4" role="alert">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-chat-square-quote text-muted mb-3" viewBox="0 0 16 16">
                        <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1h-2.5a2 2 0 0 0-1.6.8L8 14.333 6.1 11.8a2 2 0 0 0-1.6-.8H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h2.5a1 1 0 0 1 .8.4l1.9 2.533a1 1 0 0 0 1.6 0l1.9-2.533a1 1 0 0 1 .8-.4H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                        <path d="M7.066 4.76A1.665 1.665 0 0 0 4 5.668a1.667 1.667 0 0 0 2.561 1.406c-.131.389-.375.804-.777 1.22a.417.417 0 1 0 .6.58c1.486-1.54 1.293-3.214.682-4.112zm4 0A1.665 1.665 0 0 0 8 5.668a1.667 1.667 0 0 0 2.561 1.406c-.131.389-.375.804-.777 1.22a.417.417 0 1 0 .6.58c1.486-1.54 1.293-3.214.682-4.112z"/>
                    </svg>
                    <h5 class="text-muted mb-2">No Questions Yet</h5>
                    <p class="text-muted mb-0">Be the first to ask a question about this product.</p>
                </div>
            }
            else
            {
                <div class="list-group mb-4">
                    @foreach (var question in Model.Questions)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <span class="badge bg-primary me-2">Q</span>
                                    <strong>@question.BuyerDisplayName</strong>
                                </div>
                                <small class="text-muted">@question.AskedAtDisplay</small>
                            </div>
                            <p class="mb-3">@question.Question</p>
                            @if (question.IsAnswered && !string.IsNullOrEmpty(question.Answer))
                            {
                                <div class="ps-4 border-start border-success border-3">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <span class="badge bg-success me-2">A</span>
                                            <strong>@(Model.Store?.Name ?? "Seller")</strong>
                                        </div>
                                        <small class="text-muted">@question.AnsweredAtDisplay</small>
                                    </div>
                                    <p class="mb-0">@question.Answer</p>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </section>

        <!-- Recently Viewed Products Section -->
        <section class="mt-5" data-recently-viewed data-current-product-id="@Model.Product.Id" data-max-display="5" style="display: none;">
            <h4 class="mb-3">Recently Viewed</h4>
            <div class="row row-cols-2 row-cols-md-5 g-3" data-recently-viewed-list>
                <!-- Products loaded via JavaScript -->
            </div>
        </section>
    </div>
}

@section Scripts {
    <script src="~/js/recently-viewed.js" asp-append-version="true"></script>
    <script>
        // Hide the "Back to results" button if the user navigated directly to this page
        // (no referrer or referrer is from external site)
        document.addEventListener('DOMContentLoaded', function() {
            var backBtn = document.getElementById('back-to-results-btn');
            if (backBtn) {
                // Check if we have a referrer from our own site
                var referrer = document.referrer;
                var currentOrigin = window.location.origin;
                
                // Hide the button if there's no referrer or it's from an external site
                if (!referrer || !referrer.startsWith(currentOrigin)) {
                    backBtn.style.display = 'none';
                }
            }

            // Set the selected value for the review sort dropdown
            var reviewSortSelect = document.getElementById('reviewSortSelect');
            if (reviewSortSelect) {
                reviewSortSelect.value = '@Model.ReviewSort';
            }
        });

        function updateReviewSort(sortValue) {
            var url = new URL(window.location.href);
            url.searchParams.set('ReviewSort', sortValue);
            url.searchParams.set('ReviewPage', '1');
            url.hash = 'reviews';
            window.location.href = url.toString();
        }
    </script>
}
