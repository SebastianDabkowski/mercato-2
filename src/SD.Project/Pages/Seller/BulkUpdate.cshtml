@page
@model SD.Project.Pages.Seller.BulkUpdateModel
@using SD.Project.Domain.Entities
@{
    ViewData["Title"] = "Bulk Update Products";
}

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>Bulk Update Products</h1>
            <p class="text-muted mb-0">Update price and stock for multiple products at once.</p>
        </div>
        <a asp-page="/Seller/Products" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Back to Products
        </a>
    </div>

    @if (Model.Result != null)
    {
        @if (!Model.Result.IsSuccess)
        {
            <div class="alert alert-danger" role="alert">
                <h5 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Update Failed</h5>
                <ul class="mb-0">
                    @foreach (var error in Model.Result.Errors)
                    {
                        <li>@error</li>
                    }
                </ul>
            </div>
        }
        else
        {
            <div class="alert @(Model.Result.FailureCount == 0 ? "alert-success" : "alert-warning")" role="alert">
                <h5 class="alert-heading">
                    @if (Model.Result.FailureCount == 0)
                    {
                        <i class="bi bi-check-circle me-2"></i>
                        <text>Bulk Update Completed Successfully</text>
                    }
                    else
                    {
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <text>Bulk Update Completed with Warnings</text>
                    }
                </h5>
                <p class="mb-0">
                    <strong>@Model.Result.SuccessCount</strong> products updated successfully,
                    <strong>@Model.Result.FailureCount</strong> failed.
                </p>
            </div>

            @if (Model.Result.Results.Count > 0)
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Update Results</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Product</th>
                                        <th class="text-center">Status</th>
                                        <th class="text-end">Old Price</th>
                                        <th class="text-end">New Price</th>
                                        <th class="text-center">Old Stock</th>
                                        <th class="text-center">New Stock</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.Result.Results)
                                    {
                                        <tr class="@(item.IsSuccess ? "" : "table-danger")">
                                            <td>@item.ProductName</td>
                                            <td class="text-center">
                                                @if (item.IsSuccess)
                                                {
                                                    <span class="badge bg-success">Updated</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-danger">Failed</span>
                                                }
                                            </td>
                                            <td class="text-end">
                                                @if (item.OldPrice.HasValue)
                                                {
                                                    @item.OldPrice.Value.ToString("N2")
                                                }
                                                else
                                                {
                                                    <text>-</text>
                                                }
                                            </td>
                                            <td class="text-end">
                                                @if (item.NewPrice.HasValue)
                                                {
                                                    @item.NewPrice.Value.ToString("N2")
                                                }
                                                else
                                                {
                                                    <text>-</text>
                                                }
                                            </td>
                                            <td class="text-center">
                                                @if (item.OldStock.HasValue)
                                                {
                                                    @item.OldStock.Value
                                                }
                                                else
                                                {
                                                    <text>-</text>
                                                }
                                            </td>
                                            <td class="text-center">
                                                @if (item.NewStock.HasValue)
                                                {
                                                    @item.NewStock.Value
                                                }
                                                else
                                                {
                                                    <text>-</text>
                                                }
                                            </td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(item.ErrorMessage))
                                                {
                                                    <span class="text-danger">@item.ErrorMessage</span>
                                                }
                                                else
                                                {
                                                    <text>-</text>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        }
    }

    @if (Model.Products.Count == 0)
    {
        <div class="card">
            <div class="card-body text-center py-5">
                <h4 class="text-muted">No products available</h4>
                <p class="text-muted">Add some products first to use the bulk update feature.</p>
                <a asp-page="/Seller/AddProduct" class="btn btn-primary">Add Your First Product</a>
            </div>
        </div>
    }
    else
    {
        <form method="post">
            <div class="row">
                <!-- Product Selection -->
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Select Products</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <button type="button" class="btn btn-sm btn-outline-primary me-2" id="selectAll">Select All</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAll">Deselect All</button>
                            </div>
                            <div class="list-group" style="max-height: 400px; overflow-y: auto;">
                                @foreach (var product in Model.Products)
                                {
                                    <label class="list-group-item d-flex align-items-center">
                                        <input type="checkbox" name="SelectedProductIds" value="@product.Id"
                                               class="form-check-input me-3 product-checkbox"
                                               @(Model.SelectedProductIds.Contains(product.Id) ? "checked" : "") />
                                        <div class="flex-grow-1">
                                            <strong>@product.Name</strong>
                                            <div class="small text-muted">
                                                Price: @product.Amount.ToString("N2") @product.Currency |
                                                Stock: @product.Stock
                                            </div>
                                        </div>
                                        @if (product.Status == ProductStatus.Draft)
                                        {
                                            <span class="badge bg-secondary ms-2">Draft</span>
                                        }
                                        else if (product.Status == ProductStatus.Active)
                                        {
                                            <span class="badge bg-success ms-2">Active</span>
                                        }
                                        else if (product.Status == ProductStatus.Suspended)
                                        {
                                            <span class="badge bg-danger ms-2">Suspended</span>
                                        }
                                    </label>
                                }
                            </div>
                            <div class="mt-2 text-muted small">
                                <span id="selectedCount">@Model.SelectedProductIds.Count</span> product(s) selected
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Update Options -->
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Price Change</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Change Type</label>
                                <select class="form-select" name="PriceChangeType" id="priceChangeType">
                                    <option value="None" selected>No Change</option>
                                    <option value="FixedValue">Set Fixed Price</option>
                                    <option value="PercentageUp">Increase by Percentage</option>
                                    <option value="PercentageDown">Decrease by Percentage</option>
                                </select>
                            </div>
                            <div class="mb-3" id="priceValueGroup" style="display: none;">
                                <label class="form-label" id="priceValueLabel">Value</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="PriceValue" id="priceValue"
                                           step="0.01" min="0" placeholder="Enter value" />
                                    <span class="input-group-text" id="priceValueSuffix"></span>
                                </div>
                                <div class="form-text" id="priceValueHelp"></div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Stock Change</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Change Type</label>
                                <select class="form-select" name="StockChangeType" id="stockChangeType">
                                    <option value="None" selected>No Change</option>
                                    <option value="SetExact">Set Exact Value</option>
                                    <option value="Increase">Increase by Value</option>
                                    <option value="Decrease">Decrease by Value</option>
                                </select>
                            </div>
                            <div class="mb-3" id="stockValueGroup" style="display: none;">
                                <label class="form-label" id="stockValueLabel">Value</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="StockValue" id="stockValue"
                                           step="1" min="0" placeholder="Enter value" />
                                    <span class="input-group-text">units</span>
                                </div>
                                <div class="form-text" id="stockValueHelp"></div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <i class="bi bi-arrow-repeat me-2"></i>Apply Bulk Update
                        </button>
                    </div>
                </div>
            </div>
        </form>
    }
</div>

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Product selection
        const checkboxes = document.querySelectorAll('.product-checkbox');
        const selectedCount = document.getElementById('selectedCount');
        const selectAll = document.getElementById('selectAll');
        const deselectAll = document.getElementById('deselectAll');

        function updateCount() {
            const count = document.querySelectorAll('.product-checkbox:checked').length;
            selectedCount.textContent = count;
        }

        checkboxes.forEach(cb => cb.addEventListener('change', updateCount));

        selectAll?.addEventListener('click', function () {
            checkboxes.forEach(cb => cb.checked = true);
            updateCount();
        });

        deselectAll?.addEventListener('click', function () {
            checkboxes.forEach(cb => cb.checked = false);
            updateCount();
        });

        // Price change type handling
        const priceChangeType = document.getElementById('priceChangeType');
        const priceValueGroup = document.getElementById('priceValueGroup');
        const priceValueLabel = document.getElementById('priceValueLabel');
        const priceValueSuffix = document.getElementById('priceValueSuffix');
        const priceValueHelp = document.getElementById('priceValueHelp');
        const priceValue = document.getElementById('priceValue');

        priceChangeType?.addEventListener('change', function () {
            if (this.value === 'None') {
                priceValueGroup.style.display = 'none';
                priceValue.removeAttribute('required');
            } else {
                priceValueGroup.style.display = 'block';
                priceValue.setAttribute('required', 'required');

                if (this.value === 'FixedValue') {
                    priceValueLabel.textContent = 'New Price';
                    priceValueSuffix.textContent = 'currency';
                    priceValueHelp.textContent = 'Enter the exact price to set for all selected products.';
                    priceValue.setAttribute('min', '0.01');
                    priceValue.setAttribute('step', '0.01');
                } else if (this.value === 'PercentageUp') {
                    priceValueLabel.textContent = 'Percentage Increase';
                    priceValueSuffix.textContent = '%';
                    priceValueHelp.textContent = 'Enter the percentage to increase prices (e.g., 10 for 10%).';
                    priceValue.setAttribute('min', '0');
                    priceValue.setAttribute('max', '100');
                    priceValue.setAttribute('step', '0.1');
                } else if (this.value === 'PercentageDown') {
                    priceValueLabel.textContent = 'Percentage Decrease';
                    priceValueSuffix.textContent = '%';
                    priceValueHelp.textContent = 'Enter the percentage to decrease prices (e.g., 10 for 10%).';
                    priceValue.setAttribute('min', '0');
                    priceValue.setAttribute('max', '100');
                    priceValue.setAttribute('step', '0.1');
                }
            }
        });

        // Stock change type handling
        const stockChangeType = document.getElementById('stockChangeType');
        const stockValueGroup = document.getElementById('stockValueGroup');
        const stockValueLabel = document.getElementById('stockValueLabel');
        const stockValueHelp = document.getElementById('stockValueHelp');
        const stockValue = document.getElementById('stockValue');

        stockChangeType?.addEventListener('change', function () {
            if (this.value === 'None') {
                stockValueGroup.style.display = 'none';
                stockValue.removeAttribute('required');
            } else {
                stockValueGroup.style.display = 'block';
                stockValue.setAttribute('required', 'required');

                if (this.value === 'SetExact') {
                    stockValueLabel.textContent = 'New Stock Level';
                    stockValueHelp.textContent = 'Enter the exact stock level to set for all selected products.';
                } else if (this.value === 'Increase') {
                    stockValueLabel.textContent = 'Increase By';
                    stockValueHelp.textContent = 'Enter the quantity to add to current stock levels.';
                } else if (this.value === 'Decrease') {
                    stockValueLabel.textContent = 'Decrease By';
                    stockValueHelp.textContent = 'Enter the quantity to subtract from current stock levels.';
                }
            }
        });
    });
</script>
}
